# 中断

## 中断分类

### 外部中断

外部中断是指来自 CPU 外部的中断，而外部的中断源必须是某个硬件，所以外部中断又称为硬件中断。通过两条信号线通知 CPU 。

``` vim

  +---------+    
  |         |<---INTR----外部设备(External Device)
  |   CPU   |
  |         |<---NMI-----致命错误(Deadly Error)
  +---------+    
  
```

#### INTR 信号线

从这里来的中断也称可屏蔽中断。

#### NMI 信号线

从这里来的中断也称不可屏蔽中断。

### 外部中断

内部中断可分为软中断和异常。

#### int 8位立即数

系统调用

#### int3

调试断点指令，其所触发的中断向量号是 3。

#### into

中断溢出指令，它所触发的中断向量号是 4。

#### bound

这是检查数组索引越界指令，它可以触发 5 号中断，用于检查数组的索引下标是否在上下边界之内。该指令格式是“bound 16/32 位寄存器， 16/32 位内存”。目的操作数是用寄存器来存储的，其内容是待检测的数组下标值。源操作数是内存，其内容是数组下标的下边界和上边界。当执行 bound 指令时，若下标处于数组索引的范围之外，则会触发 5 号中断。

#### ud2

未定义指令，这会触发第 6 号中断。该指令表示指令无效，CPU 无法识别。主动使用它发起中断，常用于软件测试中，无实际用途。

#### 总结

对于中断是否无视 eflags 中的 IF 位，可以这么理解：

（1）首先，只要是导致运行错误的中断类型都会无视 IF 位，不受 IF 位的管束，如 NMI、异常。

（2）其次，由于 int n 型的软中断用于实现系统调用功能，不能因为 IF 位为 0 就不顾用户请求，所以为了用户功能正常，软中断必须也无视 IF 位。

总结：只要中断关系到“正常”运行，就不受 IF 位影响。

另外，这里所说的运行错误，是说指令语法方面的错误。

并不是所有的异常都很致命，按照轻重程度，可以分为以下三种。

（1）Fault，也称为故障。这种错误是可以被修复的一种类型，属于最轻的一种异常，它给软件一次“改过自新”的机会。当发生此类异常时 CPU 将机器状态恢复到异常之前的状态，之后调用中断处理程序时，CPU 将返回地址依然指向导致 fault 异常的那条指令。通常中断处理程序中会将此问题修复，待中断处理程序返回后便能重试。最典型的例子就是操作系统课程中所说的缺页异常 page fault，话说 Linux 的虚拟内存就是基于 page fault 的，这充分说明这种异常是极易被修复的，甚至是有益的。

（2）Trap，也称为陷阱，这一名称很形象地说明软件掉进了 CPU 设下的陷阱，导致停了下来。此异常通常用在调试中，比如 int3 指令便引发此类异常，为了让中断处理程序返回后能够继续向下执行，CPU 将中断处理程序的返回地址指向导致异常指令的下一个指令地址。

（3）Abort，也称为终止，从名字上看，这是最严重的异常类型，一旦出现，由于错误无法修复，程序将无法继续运行，操作系统为了自保，只能将此程序从进程表中去掉。导致此异常的错误通常是硬件错误，或者某些系统数据结构出错。

![20231016165553](https://cdn.jsdelivr.net/gh/WoodHolz/cloudimg/picture/20231016165553.png)

## 中断描述符表

中断描述符表（Interrupt Descriptor Table，IDT）是保护模式下用于存储中断处理程序入口的表

实模式下用于存储中断处理程序入口的表叫中断向量表（Interrupt Vector Table，IVT）











