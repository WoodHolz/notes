# 总结2022_8_9-2022_8_14

## Socket Buffer 穿越 TCP/IP 协议栈

### 发送

`Socket Buffer`**由上向下**穿越 TCP/IP 协议栈的各层期间会发生

* 数据包中不断加入穿越的层级的协议的头信息。
* sk_buff管理结构~~强调下以防混淆~~中描述协议头的地址指针被赋值。

### 接收

`dev_alloc_skb`申请`Socket Buffer`，将接收到的网络数据帧从设备硬件的缓冲区复制到`Socket Buffer `的数据包缓冲区；填写 `sk_buff`管理结构中的地址、接收时间和协议等信息~~填快递单~~（`Socket Buffer`到达内核地址空间~~(Kernel address space?)~~）

当`Socket Buffer`**由下向上**穿越 TCP/IP 协议栈的各层时将发生

* 数据包中不断丢弃穿越的层级的协议的头信息。
* sk_buff管理结构中描述协议头的地址指针被复位~~置零~~，并调整`sk_buff`结构中
  指向有效数据的 sk_buff->data 指针。

<img src="..\2022_8_14\Screenshot 2022-08-09 223032.png" alt="网络数据包在 TCP/IP 协议栈的传送示意图" style="zoom:50%;" />

### 优点

Socket Buffer 这样组织的优点是避免了重复复制数据，要传送的数据只需复制两次：

1. 从应用程序的用户地址空间复制到内核地址空间；
2. 从内核地址空间复制到网络适配器的硬件缓冲区中。



---



## 需要衔接的知识点

1. 套接字

2. TCP/IP各层

3. 产生中断通知内核？？？过程？？？

4. 网络数据帧

5. function `dev_alloc_skb`(我的理解是类似于C中的molloc)

   > 向系统申请`Socket Buffer`

6. sk_buff->data 指针

   * 数据包MAC协议头？？？(数据包以dataref: 1结尾)



---



# 协议栈

<img src="..\2022_8_14\Screenshot 2022-08-12 204351.png" style="zoom:50%;" />

## 上半部分

* 采用TCP协议收发数据的部分

* 采用UDP协议收发数据的部分

### 作用

> 接受应用程序的委托执行收发数据的操作



### 例子

> 浏览器、邮件等一般应用程序收发数据时用 TCP；
>
> DNS 查询等收发较短的控制数据时用 UDP。



## 下半部分

* 采用IP协议控制网络包收发操作的部分

IP 中还包括 **ICMP协议** 和 **ARP协议** 。ICMP 用于告知网络包传送过程中产生的错误以及各种控制消息，ARP 用于根据 IP 地址查询相应的以太网 MAC 地址。



---



# NAS

## 硬件

1. CPU（可以是服务器端处理器，如E3-1230 V3 ~~功耗爆炸~~）
2. 显卡（可选，如果CPU没有核显就必需，如E3-1230 V3）
3. 主板
4. 内存
5. 硬盘
6. 电源

## 系统与软件

TrueNAS(免费)

Docker容器



---



